<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Queso y Sabor — MVP</title>
  <style>
    :root{ --bg:#f6f7f9; --card:#fff; --text:#1f2937; --muted:#6b7280; --line:#e5e7eb; --radius:10px }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui, sans-serif; color:var(--text); background:var(--bg); line-height:1.45 }
    
    header{ width:min(960px,94vw); margin:12px auto 0; background:#fff; border:1px solid var(--line);
            border-radius:var(--radius); padding:10px 14px; display:flex; align-items:center; justify-content:space-between }
    .nav{ display:flex; gap:8px; align-items:center }
    .btn, button{ color:var(--text); text-decoration:none; border:1px solid var(--line); border-radius:8px;
                  padding:8px 12px; background:#fff; cursor:pointer }
    .btn:hover, button:hover{ background:#f9fafb }
    button:disabled{ opacity:.55; cursor:not-allowed }
    
    #cart-link{ position:relative; display:inline-flex; align-items:center; justify-content:center;
                width:40px; height:36px; border:1px solid var(--line); border-radius:8px; background:#fff; text-decoration:none }
    #cart-badge{ position:absolute; top:-8px; right:-8px; background:#111827; color:#fff; font-size:12px;
                 border-radius:999px; padding:2px 6px; min-width:20px; text-align:center }
    
    section{ width:min(960px,94vw); margin:20px auto; background:var(--card); border:1px solid var(--line);
             border-radius:var(--radius); padding:16px }
    
    .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px }
    h2{ margin:0; font-size:20px }
    .controls{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    
    input, select{ font:inherit; padding:10px 12px; border:1px solid var(--line); border-radius:8px; background:#fff; color:var(--text) }
    input[type="search"]{ width:100%; margin-top:8px }
    
    #filtro-activo{ padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#fff7ed; color:#92400e; font-size:14px }
    #filtro-activo[hidden], #btn-limpiar[hidden], #estado-vacio[hidden]{ display:none }
    
    ul[role="list"]{ list-style:none; padding:0; margin:12px 0 0; display:grid; gap:8px }
    li[data-id]{ display:flex; align-items:center; justify-content:space-between; border:1px solid var(--line); 
                 border-radius:8px; padding:10px 12px; background:#fff; cursor:pointer }
    li[data-id]:hover{ background:#f9fafb }
    
    #estado-vacio{ margin:10px 0 0; border:1px dashed var(--line); background:#fafafa; border-radius:8px; padding:10px 12px; color:var(--muted) }
    
    #detalle-queso .imagen{ border:1px solid var(--line); border-radius:8px; background:#fafafa; max-width:280px; margin:8px 0 12px }
    #detalle-queso .imagen img{ width:100%; height:auto; display:block; border-radius:8px }
    #detalle-queso a{ color:#111827; text-decoration:none; margin-bottom:8px; display:inline-block }
    #detalle-queso a:hover{ text-decoration:underline }
    #detalle-queso p{ margin:6px 0 }
    
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0 }
  </style>
</head>
<body>
  <header id="app-header">
    <div class="brand">Queso & Sabor</div>
    <nav class="nav">
      <a class="btn" href="mispedidos.html">Mis pedidos</a>
      <a id="cart-link" href="carrito.html" title="Carrito">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M3 3h2l2.2 9.2A2 2 0 0 0 9.1 14h7.8a2 2 0 0 0 1.9-1.5L21 8H7"
                stroke="#374151" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="10" cy="19" r="1.5" fill="#374151"/>
          <circle cx="17" cy="19" r="1.5" fill="#374151"/>
        </svg>
        <span id="cart-badge">0</span>
      </a>
    </nav>
  </header>

  <section id="buscar-queso">
    <div class="row">
      <h2>Catálogo</h2>
      <div class="controls">
        <label for="tipo-leche">Tipo de leche:</label>
        <select id="tipo-leche">
          <option value="todas">Todas</option>
          <option value="vaca">Vaca</option>
          <option value="cabra">Cabra</option>
          <option value="oveja">Oveja</option>
        </select>
        <button id="btn-limpiar" hidden>Limpiar</button>
        <span id="filtro-activo" hidden></span>
      </div>
    </div>

    <input id="buscador" type="search" placeholder="Buscar queso..." autocomplete="off" />
    <ul id="resultados" role="list"></ul>
    <p id="estado-vacio" hidden></p>
  </section>

  <section id="detalle-queso" hidden>
    <a href="#buscar-queso">← Volver</a>
    <h2>Detalle</h2>
    <div class="imagen"></div>
    <h3></h3>
    <p class="precio"></p>
    <p class="stock"></p>
    <button>Agregar al carrito</button>
    <h4>Descripción</h4>
    <p class="desc"></p>
    <h4>Notas</h4>
    <p class="notas"></p>
    <h4>Recomendaciones</h4>
    <p class="recom"></p>
  </section>

  <script>
    // === Datos y estado ===
    const PROD_KEY = "qs_products";
    const CART_KEY = "qs_cart_v1";
    
    const Cart = {
      items: {},
      load() { try { this.items = JSON.parse(localStorage.getItem(CART_KEY)) || {} } catch { this.items = {} } },
      save() { localStorage.setItem(CART_KEY, JSON.stringify(this.items)) },
      count() { return Object.values(this.items).reduce((n,it) => n + it.qty, 0) },
      add(p, qty) {
        if (!this.items[p.id]) this.items[p.id] = { ...p, qty: 0 };
        this.items[p.id].qty += qty;
        this.save();
      }
    };
    
    function loadProducts() {
      try { 
        const stored = JSON.parse(localStorage.getItem(PROD_KEY));
        return stored && stored.length ? stored : demoProducts();
      } catch { 
        return demoProducts(); 
      }
    }
    
    function demoProducts() {
      return [
        { id:"gouda-1", nombre:"Gouda clásico", precio:5990, leche:"vaca", stock:10, imagen:"img/quesogouda1.jpg",
          descripcion:"Queso holandés de sabor suave y textura cremosa.",
          notas:"Notas mantecosas, con leve dulzura.", recomendaciones:"Ideal con vino blanco seco." },
        { id:"manchego-1", nombre:"Manchego curado", precio:7990, leche:"oveja", stock:5, imagen:"img/quesomanchego1.jpeg",
          descripcion:"Queso español elaborado con leche de oveja.",
          notas:"Sabor intenso y ligeramente salado.", recomendaciones:"Perfecto con pan rústico y vino tinto." },
        { id:"cabra-1", nombre:"Queso de cabra", precio:6990, leche:"cabra", stock:0, imagen:"img/quesodecabra1.jpeg",
          descripcion:"Queso curado de cabra, sabor fuerte y persistente.",
          notas:"Aromas lácticos y toque picante.", recomendaciones:"Acompáñalo con miel o frutos secos." },
        { id:"gouda-reserva", nombre:"Gouda gran reserva", precio:9990, leche:"vaca", stock:8, imagen:"img/goudagranreserva1.jpg",
          descripcion:"Madurado, sabor profundo y textura firme.",
          notas:"Toques de nuez y caramelo.", recomendaciones:"Excelente con cerveza ámbar." },
      ];
    }
    
    let productos = loadProducts();
    let term = "";
    let filtroLeche = "todas";
    
    // === Referencias ===
    const $buscar = document.getElementById("buscador");
    const $leche = document.getElementById("tipo-leche");
    const $limpiar = document.getElementById("btn-limpiar");
    const $filtro = document.getElementById("filtro-activo");
    const $lista = document.getElementById("resultados");
    const $estado = document.getElementById("estado-vacio");
    const $detalle = document.getElementById("detalle-queso");
    const $volver = $detalle.querySelector("a");
    const $btnCarrito = $detalle.querySelector("button");
    
    // === Funciones ===
    function capitalizar(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : "" }
    function updateBadge() { document.getElementById("cart-badge").textContent = Cart.count() }
    
    function render() {
      let items = productos;
      if (term) items = items.filter(p => p.nombre.toLowerCase().includes(term));
      if (filtroLeche !== "todas") items = items.filter(p => p.leche === filtroLeche);
      
      const hayFiltro = filtroLeche !== "todas";
      $filtro.hidden = !hayFiltro;
      $limpiar.hidden = !hayFiltro;
      if (hayFiltro) $filtro.textContent = `Filtro: ${capitalizar(filtroLeche)}`;
      
      if (!items.length) {
        $lista.innerHTML = "";
        $estado.hidden = false;
        $estado.textContent = term ? "No hay productos que coincidan" : "No hay productos para este filtro";
        return;
      }
      
      $estado.hidden = true;
      $lista.innerHTML = items.map(p => `
        <li data-id="${p.id}">
          <strong>${p.nombre}</strong>
          <span>— $${p.precio.toLocaleString("es-CL")} <small>(${capitalizar(p.leche)})</small></span>
        </li>
      `).join("");
    }
    
    function mostrarDetalle(p) {
      $detalle.querySelector(".imagen").innerHTML = `<img src="${p.imagen}" alt="${p.nombre}">`;
      $detalle.querySelector("h3").textContent = p.nombre;
      $detalle.querySelector(".precio").textContent = `Precio: $${p.precio.toLocaleString("es-CL")}`;
      $detalle.querySelector(".stock").textContent = `Stock: ${p.stock > 0 ? "En stock" : "Sin stock"}`;
      $detalle.querySelector(".desc").textContent = p.descripcion;
      $detalle.querySelector(".notas").textContent = p.notas;
      $detalle.querySelector(".recom").textContent = p.recomendaciones;
      
      $btnCarrito.disabled = p.stock <= 0;
      $btnCarrito.textContent = p.stock <= 0 ? "Sin stock" : "Agregar al carrito";
      $btnCarrito.onclick = () => {
        const inCart = (Cart.items[p.id]?.qty || 0);
        if (p.stock > 0 && inCart < p.stock) {
          Cart.add(p, 1);
          updateBadge();
          alert(`✅ ${p.nombre} agregado al carrito.`);
        } else {
          alert("No hay más stock disponible.");
        }
      };
      
      $detalle.hidden = false;
      $detalle.scrollIntoView({ behavior: "smooth" });
    }
    
    // === Eventos ===
    $buscar.addEventListener("input", () => { term = $buscar.value.trim().toLowerCase(); render(); });
    $leche.addEventListener("change", () => { filtroLeche = $leche.value; render(); });
    $limpiar.addEventListener("click", () => { filtroLeche = "todas"; $leche.value = "todas"; render(); });
    
    document.addEventListener("click", e => {
      const item = e.target.closest("li[data-id]");
      if (!item) return;
      const queso = productos.find(p => p.id === item.dataset.id);
      if (queso) mostrarDetalle(queso);
    });
    
    $volver.addEventListener("click", e => {
      e.preventDefault();
      $detalle.hidden = true;
      document.getElementById("buscar-queso").scrollIntoView({ behavior: "smooth" });
    });
    
    // === Inicialización ===
    Cart.load();
    updateBadge();
    render();
  </script>
</body>
</html>