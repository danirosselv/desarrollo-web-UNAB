<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Detalle de pedido — Queso & Sabor</title>
<style>
  body{margin:0; font-family:system-ui; background:#f6f7f9; color:#1f2937; line-height:1.45}
  .container{max-width:960px; margin:auto; padding:10px}
  header{background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:10px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center}
  .btn{border:1px solid #e5e7eb; border-radius:8px; padding:8px 12px; text-decoration:none; color:#1f2937}
  section{background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:16px; margin-top:12px}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width:720px){ .grid{grid-template-columns:1fr} }
  .muted{color:#6b7280}
  .items{list-style:none; padding:0; margin:12px 0 0}
  .item{border:1px solid #e5e7eb; border-radius:8px; padding:10px; margin-bottom:8px; display:flex; gap:10px; align-items:center}
  .thumb{width:56px; height:56px; border-radius:8px; background:#f3f4f6}
  .timeline{list-style:none; padding:0; margin:12px 0 0}
  .timeline li{border:1px dashed #e5e7eb; border-radius:8px; padding:10px; margin-bottom:8px}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>Queso & Sabor</div>
    <nav style="display:flex; gap:8px; align-items:center">
      <a class="btn" href="mispedidos.html">← Pedidos</a>
      <a class="btn" href="index.html">Tienda</a>
    </nav>
  </header>

  <section id="main" hidden>
    <h2 id="title">Pedido</h2>

    <div class="grid">
      <div>
        <div id="when" class="muted"></div>
        <div id="ship"></div>
        <div id="buyer" class="muted"></div>
      </div>
      <div style="text-align:right">
        <div><strong id="total"></strong></div>
        <div id="estado" class="muted"></div>
      </div>
    </div>

    <h3 class="muted">Ítems</h3>
    <ul id="items" class="items"></ul>

    <div class="grid">
      <div>
        <h3 class="muted">Seguimiento</h3>
        <ul id="timeline" class="timeline"></ul>
      </div>
      <div style="text-align:right">
        <div class="muted">Subtotal <span id="sub"></span></div>
        <div class="muted">Envío <span id="shipcost"></span></div>
        <div style="margin-top:8px"><strong>Total <span id="tt"></span></strong></div>
      </div>
    </div>
  </section>

  <section id="notfound">
    <h2>Pedido no encontrado</h2>
    <p class="muted"><a class="btn" href="mispedidos.html">Volver a pedidos</a></p>
  </section>
</div>

<script>
// Badge carrito
function cartCount(){
  try{ 
    const cart = JSON.parse(localStorage.getItem("qs_cart_v1")||"{}")
    return Object.values(cart).reduce((n,it)=>n+it.qty,0)
  }catch{ return 0 }
}

// Cargar pedido
const params = new URLSearchParams(location.search)
const id = params.get("id")
const orders = JSON.parse(localStorage.getItem("qs_orders")||"[]")
const order = orders.find(o => String(o.id) === String(id))

const $main = document.getElementById("main")
const $nf = document.getElementById("notfound")

if(order){
  $main.hidden = false
  $nf.hidden = true

  // Información básica
  const date = new Date(order.createdAt || Date.now())
  $title.textContent = `Pedido ${order.id}`
  $when.textContent = date.toLocaleDateString("es-CL")
  $estado.textContent = `Estado: ${order.status?.current || "Confirmado"}`
  $total.textContent = `$${order.total?.toLocaleString() || '0'}`
  $sub.textContent = `$${order.subtotal?.toLocaleString() || '0'}`
  $shipcost.textContent = `$${order.shipping?.toLocaleString() || '0'}`
  $tt.textContent = `$${order.total?.toLocaleString() || '0'}`

  // Envío
  $ship.textContent = order.shippingMethod === "retiro" 
    ? `Retiro: ${order.shippingDetail?.sucursal || "Tienda"}`
    : `Despacho: ${order.shippingDetail?.comuna || "Domicilio"}`

  // Comprador
  $buyer.textContent = order.buyer ? `${order.buyer.nombre} • ${order.buyer.email}` : ""

  // Ítems
  $items.innerHTML = Object.values(order.items||{}).map(it => 
    `<li class="item">
      <img class="thumb" src="${it.imagen||''}" onerror="this.style.display='none'">
      <div>
        <div><strong>${it.nombre}</strong></div>
        <div class="muted">${it.qty} × $${it.precio?.toLocaleString()}</div>
      </div>
      <div style="margin-left:auto"><strong>$${(it.qty*it.precio)?.toLocaleString()}</strong></div>
    </li>`
  ).join("")

  // Timeline
  const hist = order.statusHistory || [
    { label:"Pago confirmado", at: order.createdAt || Date.now() },
    { label:"Preparando pedido", at: (order.createdAt || Date.now()) + 2*60*60*1000 },
    { label: order.shippingMethod === "retiro" ? "Listo para retiro" : "En reparto", 
      at: (order.createdAt || Date.now()) + 6*60*60*1000 }
  ]
  
  $timeline.innerHTML = hist.map(h => 
    `<li>
      <div><strong>${h.label}</strong></div>
      <div class="muted">${new Date(h.at).toLocaleDateString("es-CL")}</div>
    </li>`
  ).join("")
  
}else{
  $main.hidden = true
  $nf.hidden = false
}
</script>
</body>
</html>