<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mi perfil — Queso & Sabor</title>
<style>
body{margin:0;font-family:system-ui;background:#f6f7f9}
.wrap{max-width:600px;margin:auto;padding:10px}
header,section{background:#fff;border:1px solid #ddd;border-radius:8px;padding:12px;margin:8px 0}
header{display:flex;justify-content:space-between}
.btn{border:1px solid #ddd;border-radius:6px;padding:6px 12px;text-decoration:none;color:#333}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:8px 0}
.addr{border:1px solid #ddd;border-radius:6px;padding:8px;margin:6px 0;display:flex;justify-content:space-between}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <a class="btn" href="index.html">← Tienda</a>
    <button class="btn" id="logout">Salir</button>
  </header>

  <section id="needlogin" hidden>
    <p>Inicia sesión para ver tu perfil.</p>
    <a class="btn" href="login.html">Ingresar</a>
  </section>

  <section id="content" hidden>
    <h3>Datos</h3>
    <div class="grid">
      <input id="u-name" disabled>
      <input id="u-mail" disabled>
    </div>

    <h3>Direcciones</h3>
    <div class="grid">
      <input id="a-text" placeholder="Dirección">
      <select id="a-comuna">
        <option>Providencia</option>
        <option>Ñuñoa</option>
        <option>Las Condes</option>
      </select>
    </div>
    <button class="btn" id="add">Guardar dirección</button>

    <div id="alist"></div>
  </section>
</div>

<script>
const session = JSON.parse(localStorage.getItem("qs_session")||"null")
if(!session){
  document.getElementById("needlogin").hidden=false
}else{
  document.getElementById("content").hidden=false
  const users=JSON.parse(localStorage.getItem("qs_users")||"[]")
  const user=users.find(u=>u.email===session.email)||{}
  
  document.getElementById("u-name").value=user.nombre||""
  document.getElementById("u-mail").value=user.email||""
  
  document.getElementById("logout").onclick=()=>{
    localStorage.removeItem("qs_session")
    location.href="index.html"
  }

  function renderAddrs(){
    const users=JSON.parse(localStorage.getItem("qs_users")||"[]")
    const user=users.find(u=>u.email===session.email)||{}
    const addrs=user.direcciones||[]
    document.getElementById("alist").innerHTML=addrs.map(a=>`
      <div class="addr">
        <div>${a.texto}, ${a.comuna} ${a.principal?"⭐":""}</div>
        <div>
          <button class="btn" onclick="setPrincipal('${a.id}')">Principal</button>
          <button class="btn" onclick="deleteAddr('${a.id}')">Eliminar</button>
        </div>
      </div>
    `).join("")
  }

  window.setPrincipal=(id)=>{
    const users=JSON.parse(localStorage.getItem("qs_users")||"[]")
    const i=users.findIndex(u=>u.email===session.email)
    if(i===-1)return
    users[i].direcciones=users[i].direcciones.map(a=>({...a,principal:a.id===id}))
    localStorage.setItem("qs_users",JSON.stringify(users))
    renderAddrs()
  }

  window.deleteAddr=(id)=>{
    const users=JSON.parse(localStorage.getItem("qs_users")||"[]")
    const i=users.findIndex(u=>u.email===session.email)
    if(i===-1)return
    users[i].direcciones=users[i].direcciones.filter(a=>a.id!==id)
    localStorage.setItem("qs_users",JSON.stringify(users))
    renderAddrs()
  }

  document.getElementById("add").onclick=()=>{
    const texto=document.getElementById("a-text").value.trim()
    const comuna=document.getElementById("a-comuna").value
    if(!texto)return
    
    const users=JSON.parse(localStorage.getItem("qs_users")||"[]")
    const i=users.findIndex(u=>u.email===session.email)
    if(i===-1)return
    
    users[i].direcciones=[
      ...users[i].direcciones||[],
      {id:Date.now().toString(),texto,comuna,principal:!users[i].direcciones?.length}
    ]
    localStorage.setItem("qs_users",JSON.stringify(users))
    document.getElementById("a-text").value=""
    renderAddrs()
  }

  renderAddrs()
}
</script>
</body>
</html>