<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WebPay Sim — Queso & Sabor</title>
<style>
  body{margin:0; font-family:system-ui; background:#f6f7f9; color:#1f2937; line-height:1.45}
  .container{max-width:960px; margin:auto; padding:10px}
  header{background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:10px; margin-bottom:12px; display:flex; justify-content:space-between}
  .btn{border:1px solid #e5e7eb; border-radius:8px; padding:8px 12px; text-decoration:none; color:#1f2937}
  section{background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:16px; margin-top:12px}
  form{display:grid; gap:10px; max-width:420px; margin-top:12px}
  input{padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px}
  .actions{display:flex; gap:10px; margin-top:10px}
  button{padding:10px 14px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; cursor:pointer}
  .msg{margin:8px 0 0; padding:10px; border-radius:8px; background:#fee2e2; color:#b91c1c; display:none}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>WebPay Sim</div>
    <nav style="display:flex; gap:8px">
      <a class="btn" href="carrito.html">← Carrito</a>
      <a class="btn" href="index.html">Tienda</a>
    </nav>
  </header>

  <section>
    <h2>Pagar</h2>
    <p><strong>Total: <span id="monto">$0</span></strong></p>
    <p style="color:#6b7280; margin-top:8px">
      Reglas: <b>0000</b> = Error • <b>1111</b> = Rechazado • Otro = Aprobado
    </p>

    <div id="msg" class="msg"></div>

    <form id="payform">
      <input id="card-name" placeholder="Nombre">
      <input id="card-number" placeholder="Número tarjeta" inputmode="numeric">
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
        <input id="card-exp" placeholder="MM/AA">
        <input id="card-cvv" placeholder="CVV" inputmode="numeric">
      </div>

      <div class="actions">
        <button type="submit">Pagar</button>
        <a class="btn" href="carrito.html">Cancelar</a>
      </div>
    </form>
  </section>
</div>

<script>
const qs = new URLSearchParams(location.search)
const pending = JSON.parse(localStorage.getItem("qs_pending_order") || "null")
const amount = pending?.total || Number(qs.get("amount") || 0)

document.getElementById("monto").textContent = `$${amount.toLocaleString()}`

if(!pending){
  document.getElementById("msg").style.display = "block"
  document.getElementById("msg").textContent = "No hay orden pendiente"
  document.querySelector("button").disabled = true
}

document.getElementById("payform").addEventListener("submit", e=>{
  e.preventDefault()
  if(!pending) return

  const num = (document.getElementById("card-number").value||"").replace(/\D+/g,"")
  const last4 = num.slice(-4)
  const name = document.getElementById("card-name").value.trim()
  const exp = document.getElementById("card-exp").value.trim()
  const cvv = document.getElementById("card-cvv").value.trim()

  let status = "ok"
  if(last4 === "0000") status = "error"
  else if(!name || !num || !exp || !cvv || last4 === "1111") status = "rechazo"

  if(status === "ok"){
    const orders = JSON.parse(localStorage.getItem("qs_orders") || "[]")
    orders.push({
      ...pending,
      createdAt: Date.now(),
      status: { current: "nuevo" }
    })
    localStorage.setItem("qs_orders", JSON.stringify(orders))
    localStorage.removeItem("qs_pending_order")
    localStorage.removeItem("qs_cart_v1")
  }

  location.href = `pagoresultado.html?status=${status}&orderId=${pending.id}`
})
</script>
</body>
</html>