<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>√âpica 2 ‚Äî Carrito</title>

<style>
  /* =========================================================
     EPICA 2 ‚Äî ESTILOS BASE (US-05/US-06)
     ========================================================= */
  :root{
    --bg:#f6f7f9; --card:#fff; --text:#1f2937; --muted:#6b7280; --line:#e5e7eb;
    --accent:#fbbf24; --radius:10px;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui, Segoe UI, Roboto, Arial; color:var(--text); background:var(--bg); line-height:1.45}
  .container{width:min(960px,94vw); margin:18px auto}

  /* ===== Header (igual a index) ===== */
  header{
    background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
    padding:10px 14px; display:flex; align-items:center; justify-content:space-between;
  }
  .brand{font-weight:700}
  .cart{ position:relative; display:inline-flex; align-items:center; justify-content:center;
         width:40px; height:36px; border:1px solid var(--line); border-radius:8px; background:#fff; text-decoration:none }
  .badge{ position:absolute; top:-8px; right:-8px; background:#111827; color:#fff; font-size:12px;
          border-radius:999px; padding:2px 6px; min-width:20px; text-align:center }

  /* ===== Card principal ===== */
  section{
    background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
    padding:16px; margin-top:12px;
  }
  h2{ margin:0 0 12px; font-size:20px }

  /* =========================================================
     US-05 ‚Äî LISTA DE √çTEMS + CONTROLES
     ========================================================= */
  .items{ list-style:none; padding:0; margin:0; display:grid; gap:10px }
  .item{
    border:1px solid var(--line); border-radius:8px; padding:12px;
    display:grid; grid-template-columns: 56px 1fr auto; gap:12px; align-items:center; background:#fff;
  }
  .thumb{ width:56px; height:56px; border-radius:8px; object-fit:cover; display:block; background:#f3f4f6; }
  .name{ font-weight:600 }
  .unit{ color:var(--muted); font-size:14px }
  .right{ display:flex; align-items:center; gap:8px }
  .qtybox{ display:inline-flex; align-items:center; border:1px solid var(--line); border-radius:8px; overflow:hidden }
  .qtybox button{ width:28px; height:28px; border:0; background:#fff; cursor:pointer }
  .qtybox span{ width:32px; text-align:center; font-variant-numeric:tabular-nums }
  .remove{ border:1px solid var(--line); background:#fff; border-radius:8px; width:34px; height:34px; cursor:pointer }

  /* =========================================================
     US-06 ‚Äî RESUMEN DE TOTALES
     ========================================================= */
  .totals{ border-top:1px dashed var(--line); margin-top:12px; padding-top:12px; display:grid; gap:8px; }
  .row{ display:flex; justify-content:space-between; align-items:center; gap:10px }
  .muted{ color:var(--muted) }
  select{ font:inherit; padding:10px 12px; border:1px solid var(--line); border-radius:8px; background:#fff; color:var(--text) }

  .actions{ margin-top:10px; display:flex; gap:10px; flex-wrap:wrap }
  button.primary{ background:#fff; border:1px solid var(--line); border-radius:8px; padding:10px 14px; cursor:pointer }
  button.primary:hover{ background:#f9fafb }
  a.link{ color:#1f2937; text-decoration:none; border:1px solid var(--line); border-radius:8px; padding:8px 12px; background:#fff }
  a.link:hover{ background:#f9fafb }

  /* ===== Estado vac√≠o ===== */
  .empty{ text-align:center; color:var(--muted); padding:24px 8px }
  .empty .cart-draw{ font-size:64px; line-height:1; margin-bottom:8px }

  /* ===== EPICA 3 ‚Äî Datos comprador (US-07) ===== */
  .buyer { margin:10px 0 6px }
  .buyer h3 { margin:0 0 8px; font-size:16px; color:var(--muted) }
  .buyer .grid { display:grid; grid-template-columns:1fr 1fr; gap:8px }
  .buyer input {
    font:inherit; padding:10px 12px; border:1px solid var(--line);
    border-radius:8px; background:#fff; color:var(--text);
  }
  .buyer .error { color:#b91c1c; font-size:14px; margin-top:6px }
  button.primary:disabled{ opacity:.55; cursor:not-allowed }
  @media (max-width:640px){ .buyer .grid{ grid-template-columns:1fr } }

  /* ===== EPICA 4 ‚Äî m√©todo de env√≠o (US-11/12) ===== */
  .ship-group{ display:flex; gap:10px; flex-wrap:wrap }
  .ship-group label{ display:flex; gap:6px; align-items:center }
</style>
</head>
<body>

<div class="container">
  <!-- =========================================================
       HEADER
       ========================================================= -->
  <header>
    <a class="link" href="index.html">‚Üê Volver a la tienda</a>
    <div class="brand">Queso & Sabor</div>
    <a class="cart" href="carrito.html" title="Tu carrito">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M3 3h2l2.2 9.2A2 2 0 0 0 9.1 14h7.8a2 2 0 0 0 1.9-1.5L21 8H7"
              stroke="#374151" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="10" cy="19" r="1.5" fill="#374151"/>
        <circle cx="17" cy="19" r="1.5" fill="#374151"/>
      </svg>
      <span id="cart-badge" class="badge">0</span>
    </a>
  </header>

  <!-- =========================================================
       US-06: RESUMEN DEL PEDIDO (incluye US-05)
       ========================================================= -->
  <section>
    <h2>Resumen del pedido</h2>

    <!-- B2: Carrito vac√≠o -->
    <div id="empty" class="empty" hidden>
      <div class="cart-draw">üõí</div>
      <p>Tu carrito est√° vac√≠o</p>
      <a class="link" href="index.html">Ir a la tienda</a>
    </div>

    <!-- B1: Con √≠tems -->
    <ul id="items" class="items"></ul>

    <!-- ===== Resumen de totales (US-11/US-12 + US-07) ===== -->
    <div id="totals" class="totals" hidden>
      <h3 class="muted" style="margin:0 0 8px">Resumen de totales</h3>

      <div class="row">
        <span class="muted">Subtotal</span>
        <strong id="t-subtotal">$0</strong>
      </div>

      <!-- M√©todo de env√≠o -->
      <div class="row">
        <span class="muted">M√©todo</span>
        <div class="ship-group" role="radiogroup" aria-label="M√©todo de env√≠o">
          <label><input type="radio" name="shipmethod" id="m-despacho" value="despacho"> Despacho a domicilio</label>
          <label><input type="radio" name="shipmethod" id="m-retiro" value="retiro"> Retiro en tienda</label>
        </div>
      </div>

      <!-- Si despacho: comuna -->
      <div id="row-comuna" class="row">
        <label class="muted" for="ship-comuna">Comuna</label>
        <select id="ship-comuna"></select>
      </div>

      <!-- Si retiro: sucursal -->
      <div id="row-sucursal" class="row" hidden>
        <label class="muted" for="ship-sucursal">Sucursal</label>
        <select id="ship-sucursal"></select>
      </div>

      <div class="row"><span class="muted">Costo de env√≠o</span><strong id="t-shipping">$0</strong></div>
      <div class="row" style="font-size:18px">
        <span><strong>Total</strong></span>
        <strong id="t-total">$0</strong>
      </div>

      <!-- Datos comprador (US-07) -->
      <div id="buyer" class="buyer">
        <h3>Datos de env√≠o / contacto</h3>
        <div class="grid">
          <input id="b-nombre" placeholder="Nombre y apellido" autocomplete="name" required>
          <input id="b-email" type="email" placeholder="Email" autocomplete="email" required>
          <input id="b-dire" placeholder="Direcci√≥n (solo si es despacho)" style="grid-column:1/-1">
        </div>
        <p id="buyer-error" class="error" hidden>Completa los datos requeridos para continuar.</p>
      </div>

      <div class="actions">
        <button id="btn-checkout" class="primary">Continuar con el pago</button>
        <button id="btn-clear" class="primary" title="Vaciar carrito">Vaciar carrito</button>
      </div>
    </div>
  </section>
</div>

<!-- =========================================================
     JS
     ========================================================= -->
<script>
  /* =========================================================
     M√ìDULO DE CARRITO (COMPATIBLE CON INDEX)
     ========================================================= */
  const CART_KEY = "qs_cart_v1";
  const Cart = {
    items:{},
    load(){ try{ this.items = JSON.parse(localStorage.getItem(CART_KEY)) || {}; } catch{ this.items = {}; } },
    save(){ localStorage.setItem(CART_KEY, JSON.stringify(this.items)); },
    count(){ return Object.values(this.items).reduce((n,it)=>n+it.qty,0); },
    subtotal(){ return Object.values(this.items).reduce((s,it)=>s + it.qty*it.precio, 0); },
    updateQty(id, delta){
      if(!this.items[id]) return;
      this.items[id].qty += delta;
      if(this.items[id].qty <= 0) delete this.items[id];
      this.save();
    },
    remove(id){ delete this.items[id]; this.save(); },
    clear(){ this.items = {}; this.save(); }
  };

  // Badge header
  function updateBadge(){ document.getElementById("cart-badge").textContent = Cart.count(); }

  // ===== Referencias UI
  const $items = document.getElementById("items");
  const $empty = document.getElementById("empty");
  const $totals = document.getElementById("totals");
  const $tSubtotal = document.getElementById("t-subtotal");
  const $tShipping = document.getElementById("t-shipping");
  const $tTotal = document.getElementById("t-total");

  // Env√≠o
  const $mDespacho   = document.getElementById("m-despacho");
  const $mRetiro     = document.getElementById("m-retiro");
  const $rowComuna   = document.getElementById("row-comuna");
  const $rowSucursal = document.getElementById("row-sucursal");
  const $selComuna   = document.getElementById("ship-comuna");
  const $selSucursal = document.getElementById("ship-sucursal");

  // Comprador
  const $bn = document.getElementById("b-nombre");
  const $be = document.getElementById("b-email");
  const $bd = document.getElementById("b-dire");
  const $err = document.getElementById("buyer-error");
  const $btnPay = document.getElementById("btn-checkout");

  /* ===== EPICA 4 ‚Äî Env√≠o (US-11/12) ===== */
  const COSTO_POR_COMUNA = {
    "Santiago Centro":1990,
    "Providencia":2490,
    "√ëu√±oa":2490,
    "Las Condes":2990
  };
  const SUCURSALES = ["Providencia","√ëu√±oa","Las Condes"];

  const SHIP_METHOD_KEY   = "qs_ship_method_v1";   // "despacho" | "retiro"
  const SHIP_COMUNA_KEY   = "qs_ship_comuna_v1";
  const SHIP_SUCURSAL_KEY = "qs_ship_sucursal_v1";

  function getSavedMethod(){ return localStorage.getItem(SHIP_METHOD_KEY) || "retiro"; }
  function setSavedMethod(v){ localStorage.setItem(SHIP_METHOD_KEY, v); }
  function getSavedComuna(){ return localStorage.getItem(SHIP_COMUNA_KEY) || "Santiago Centro"; }
  function setSavedComuna(v){ localStorage.setItem(SHIP_COMUNA_KEY, v); }
  function getSavedSucursal(){ return localStorage.getItem(SHIP_SUCURSAL_KEY) || "Providencia"; }
  function setSavedSucursal(v){ localStorage.setItem(SHIP_SUCURSAL_KEY, v); }

  /* ===== Util ===== */
  function money(n){ return `$${n.toLocaleString("es-CL")}`; }
  function getShipMethod(){
    return document.querySelector('input[name="shipmethod"]:checked')?.value || "retiro";
  }
  function getShipCost(){
    return getShipMethod()==="despacho" ? (COSTO_POR_COMUNA[$selComuna.value] || 0) : 0;
  }

  /* ===== Validaci√≥n comprador (US-07) ===== */
  function buyerOk(){
    const nameOk  = ($bn?.value || "").trim();
    const emailOk = /\S+@\S+\.\S+/.test(($be?.value || "").trim());
    const direOk  = getShipMethod()==="despacho" ? (($bd?.value || "").trim()) : true;
    return nameOk && emailOk && direOk;
  }
  function syncPayBtn(){
    if (!$btnPay) return;
    $btnPay.disabled = !buyerOk();
    $err.hidden = true;
  }
  [$bn,$be,$bd].forEach($i => $i && $i.addEventListener("input", syncPayBtn));

  /* ===== UI de env√≠o ===== */
  function initShippingUI(){
    // llenar selects
    $selComuna.innerHTML   = Object.keys(COSTO_POR_COMUNA).map(c=>`<option>${c}</option>`).join("");
    $selSucursal.innerHTML = SUCURSALES.map(s=>`<option>${s}</option>`).join("");

    // cargar guardados
    (getSavedMethod()==="despacho" ? $mDespacho : $mRetiro).checked = true;
    $selComuna.value   = getSavedComuna();
    $selSucursal.value = getSavedSucursal();

    applyShipUI();

    // listeners
    [$mDespacho, $mRetiro].forEach(r => r.addEventListener("change", ()=>{
      setSavedMethod(getShipMethod());
      applyShipUI(); calcTotals();
    }));
    $selComuna.addEventListener("change", ()=>{ setSavedComuna($selComuna.value); calcTotals(); });
    $selSucursal.addEventListener("change", ()=>{ setSavedSucursal($selSucursal.value); calcTotals(); });
  }

  function applyShipUI(){
    const isDespacho = getShipMethod()==="despacho";
    $rowComuna.hidden   = !isDespacho;
    $rowSucursal.hidden =  isDespacho;
  }

  /* ===== Totales ===== */
  function calcTotals(){
    const shipping = getShipCost();
    const subtotal = Cart.subtotal();
    const total = subtotal + shipping;
    $tSubtotal.textContent = money(subtotal);
    $tShipping.textContent = money(shipping);
    $tTotal.textContent    = money(total);
    syncPayBtn();
  }

  /* ===== Render principal (US-05 + US-06) ===== */
  function render(){
    const ids = Object.keys(Cart.items);
    const isEmpty = ids.length === 0;

    $empty.hidden = !isEmpty;
    $totals.hidden = isEmpty;
    updateBadge();

    if(isEmpty){ $items.innerHTML = ""; return; }

    $items.innerHTML = ids.map(id => {
      const it = Cart.items[id];
      const subtotalItem = it.precio * it.qty;
      const img = it.imagen || "";
      return `
        <li class="item" data-id="${id}">
          <img class="thumb" src="${img}" alt="" onerror="this.style.display='none'">
          <div>
            <div class="name">${it.nombre}</div>
            <div class="unit">Precio: $${it.precio.toLocaleString("es-CL")} c/u (x${it.qty})</div>
          </div>
          <div class="right">
            <div class="qtybox" role="group" aria-label="Control de cantidad">
              <button class="btn-dec" aria-label="Restar uno">‚àí</button>
              <span class="qty">${it.qty}</span>
              <button class="btn-inc" aria-label="Sumar uno">Ôºã</button>
            </div>
            <div class="unit"><strong>Total: $${subtotalItem.toLocaleString("es-CL")}</strong></div>
            <button class="remove" title="Eliminar">üóëÔ∏è</button>
          </div>
        </li>
      `;
    }).join("");

    // Eventos por item
    $items.querySelectorAll(".item").forEach($li => {
      const id = $li.dataset.id;
      $li.querySelector(".btn-inc").addEventListener("click", () => { Cart.updateQty(id, +1); render(); });
      $li.querySelector(".btn-dec").addEventListener("click", () => { Cart.updateQty(id, -1); render(); });
      $li.querySelector(".remove").addEventListener("click", () => { Cart.remove(id); render(); });
    });

    calcTotals();
  }

  /* ===== Init ===== */
  Cart.load();
  initShippingUI();
  render();
  syncPayBtn();

  /* ===== Acciones ===== */
  document.getElementById("btn-clear").addEventListener("click", () => {
    if(confirm("¬øVaciar carrito?")){ Cart.clear(); render(); }
  });

  document.getElementById("btn-checkout").addEventListener("click", () => {
    if (!buyerOk()){
      $err.hidden = false;
      return;
    }

    const method   = getShipMethod();
    const shipping = getShipCost();
    const shippingDetail = method==="despacho"
      ? { comuna: $selComuna.value }
      : { sucursal: $selSucursal.value };

    const order = {
      id: `ORD-${Date.now()}`,
      buyer: {
        nombre: $bn.value.trim(),
        email:  $be.value.trim(),
        dire:   $bd.value.trim(),
      },
      items: Cart.items,
      subtotal: Cart.subtotal(),
      shipping,
      shippingMethod: method,
      shippingDetail
    };
    order.total = order.subtotal + order.shipping;

    localStorage.setItem("qs_pending_order", JSON.stringify(order));

    const params = new URLSearchParams({ orderId: order.id, amount: order.total });
    window.location.href = `webpaysim.html?${params.toString()}`;
  });
</script>
</body>
</html>
