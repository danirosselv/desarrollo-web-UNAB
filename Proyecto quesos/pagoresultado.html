<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Resultado del pago</title>
<style>
  body{margin:0;font-family:system-ui;background:#f6f7f9;color:#1f2937}
  .wrap{max-width:720px;margin:24px auto;padding:0 10px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:16px}
  .box{border:1px solid #e5e7eb;border-radius:10px;padding:24px;margin:10px 0;background:#fafafa;text-align:center}
  .icon{font-size:56px}
  .row{display:flex;gap:10px;margin-top:10px}
  a,button{padding:10px 14px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;text-decoration:none;color:#1f2937}
  .items{list-style:none;margin:10px 0 0;padding:0}
  .items li{display:flex;justify-content:space-between;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;margin-bottom:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1 id="title">Resultado del pago</h1>
    <div id="box" class="box"></div>
    <div id="info"></div>
    <ul id="items" class="items"></ul>
    <div class="row" id="actions"></div>
  </div>
</div>

<script>
const qs = new URLSearchParams(location.search)
const status = (qs.get("status") || "").toLowerCase()
const orderId = qs.get("orderId") || ""

function loadPending(){ 
  return JSON.parse(localStorage.getItem("qs_pending_order") || "null") 
}

function loadOrders(){ 
  return JSON.parse(localStorage.getItem("qs_orders") || "[]") 
}

function renderItems(order){
  if(!order?.items) return
  $items.innerHTML = Object.values(order.items).map(it => 
    `<li><span>${it.nombre} x${it.qty}</span><span>$${(it.qty*it.precio).toLocaleString()}</span></li>`
  ).join("")
}

const $title = document.getElementById("title")
const $box = document.getElementById("box")
const $info = document.getElementById("info")
const $items = document.getElementById("items")
const $actions = document.getElementById("actions")

if(status === "ok"){
  const orders = loadOrders()
  const order = orders.find(o => o.id === orderId)

  if(order){
    $title.textContent = "Pago exitoso"
    $box.innerHTML = `<div class="icon">✅</div><p>Tu pago fue aprobado</p>`
    $info.innerHTML = `Orden <strong>${order.id}</strong> - $${order.total?.toLocaleString() || '0'}`
    renderItems(order)
    $actions.innerHTML = `<a href="mispedidos.html">Mis pedidos</a><a href="index.html">Tienda</a>`
  }else{
    $title.textContent = "Pago realizado"
    $box.innerHTML = `<div class="icon">✅</div><p>Transacción aprobada</p>`
    $actions.innerHTML = `<a href="mispedidos.html">Mis pedidos</a><a href="index.html">Tienda</a>`
  }
}
else if(status === "rechazo" || status === "error"){
  const pending = loadPending()
  const msg = status === "rechazo" ? "Transacción rechazada" : "Error en el pago"
  
  $title.textContent = "Pago fallido"
  $box.innerHTML = `<div class="icon">⚠️</div><p>${msg}</p>`

  if(pending){
    $info.innerHTML = `Orden <strong>${pending.id}</strong> - $${pending.total?.toLocaleString() || '0'}`
    renderItems(pending)
    const params = new URLSearchParams({ orderId: pending.id, amount: pending.total })
    $actions.innerHTML = `<a href="webpaysim.html?${params}">Reintentar</a><a href="carrito.html">Carrito</a>`
  }else{
    $actions.innerHTML = `<a href="carrito.html">Carrito</a>`
  }
}
else{
  const pending = loadPending()
  $title.textContent = "Sin orden"
  $box.innerHTML = `<div class="icon">⚠️</div><p>Vuelve al carrito</p>`
  $actions.innerHTML = `<a href="carrito.html">Carrito</a>`
  if(pending){
    $info.innerHTML = `Orden pendiente: <strong>${pending.id}</strong>`
  }
}
</script>
</body>
</html>